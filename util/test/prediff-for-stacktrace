#!/usr/bin/env bash
#
# This script is a system-wide prediff for use when stack tracing is enabled.
# If the test doesn't present a stack trace in the expected output, this script
# will remove the stack trace (if present) in the generated output.
#
# Can also be used with the environment variable (on bash)
#
#  export CHPL_SYSTEM_PREDIFF=$CHPL_HOME/util/test/prediff-for-stacktrace

# This skips some specific tests (for example tests that produce binary output)
case "$1" in
  # binary output, no newline
  ( mandelbrot | mandelbrot-complex | mandelbrot-dist | mandelbrot-fancy)
  exit
  # text output, no newline - which ones?
  ( declprintint | fwriteIntFile | fwriteMultipleInts | fwriteIntStdout )
  exit
esac

# If the good file has a stack trace, the expected output should have it too
if grep -q "Stacktrace.*" $1.good ; then
  exit
fi

# The .good file doesn't have a stack trace, we should remove it from the
# generated output
outfile=$2
# This will remove all the function lines
grep -a -v -E "[[a-zA-Z0-9]+\(\) at .*:.*]*" $outfile > $outfile.tmp
# This will remove the stack trace prologue
perl -i -pe 'BEGIN{undef $/;} s/\nStacktrace\n\n//smg' $outfile.tmp
mv $outfile.tmp $outfile
