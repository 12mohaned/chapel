<!DOCTYPE HTML>
<html>
<head>
</head>
<body bgcolor="ffffff">
<div>
<img src="chapel-a.png" style="float:left">
<img src="cray-a.png" style="float:right">
<div style="text-align:center">
<pre>



</pre>
<h1>chplvis</h1>
<h3>A task and communication debug tool for Chapel</h3>
</div>
</div>
<br/>
<div style="margin:40px">
<p>
<em>chplvis</em> is a tool to help the Chapel program visualize their
Chapel program's tasks and communication between locales.  Using the
standard module <em>VisualDebug</em>, the programer controls what part
of their program generates information for chplvis.  During the run of
a program using the <em>VisualDebug</em> module, data files are
created that are used as input for <em>chplvis</em>.  This document
will help you understand the <em>VisualDebug</em> module and the
<em>chplvis</em> tool.
</p>

<h3>Setup</h3>
<p>
<em>chplvis</em> is built by giving the command <em>"make chplvis"</em>
at the top level of the chapel tree.  This also builds
the GUI tool, <em>FLTK</em>, required to build and
run <em>chplvis</em>.  (Note: Some versions of Linux may require the
standard package <em>libx11-dev</em> to be installed before <em>FLTK</em> will
compile properly.)  To get the most out of this primer, you should
compile and run the example programs and examine
the <em>VisualDebug</em> results with <em>chplvis</em>.  The graphics
in this primer were produced on a system using the <em>fifo</em> package
instead of <em>qthreads</em> for the tasking layer.   If you use
<em>qthreads</em>, your task count may differ from the examples.
</p>

<h3>Chapel Source Code</h3>
<p>
To use <em>chplvis</em>, the programmer adds code to their program.  In many
cases, the programmer may want to investigate only part of the program.  This
is accomplished by having functions <em>startVdebug(name)</em> and
<em>stopVdebug()</em> to control where to start and stop the instrumentation
of their program.  Compilation and execution of these programs remain the
same.  When the <em>startVdebug(name)</em> is executed, a collection
of files, one per locale, are created in a directory with the <em>name</em> given
in <em>startVdebug(name)</em>.
</p>

<h4>Example 1</h4>
<p>
Consider the chapel program: (prog1.chpl)
<pre style="margin:20px">
//  Example 1 using visual debug

use VisualDebug;

startVdebug("E1");

coforall loc in Locales do
   on loc do writeln("Hello from locale " + here.id + ".");

stopVdebug();
</pre>
</p>

<p>
Compiling the program and running it with the options "-nl 6" will then
produce a directory called <em>E1</em> containing 6 data files, one
for each of the locales and named <em>E1-n</em> where <em>n</em> is
replaced with the locale number, a number from 0 to 5.  Once this
directory is created, one can run chplvis as <em>chplvis E1</em> or
simply <em>chplvis</em> and then opening the file <em>E1/E1-0</em>
from the <em>file/open</em> menu.  The resulting diplay is:
</p>
<img src="E1.png" style="margin:10px; border: 2px solid black;">
<p>
(Note: This image is from an X11 display.  On OS-X, the menu bar
will be on the normal menu bar at the top of the screen and will
not show in the main window.)
</p>
<h4>chplvis Elements</h4>
<ul>
<li><em>Locale</em> is represented by a box.  The initial display
draws the color of the locale to represent the number of tasks run
at that locale.   For example 1, we can see that locale 0 has the
most tasks and we expect that to be 13 since that is the maximum
number of tasks as shown by the color reference at the top of the
window.</li>
<li><em>Communication links</em> are shown by lines between two
locale boxes.  The color of the line adjacent to a locale box 
represents the data being sent to that locale from the locale on
the other end.   For example 1, the line between locale 0 and
locale 1 is colored red next to locale 0.  This means that there
is a lot of communications <em>into locale 0</em> from locale 1.
The blue line next to locale 1 means that there is little 
communication <em>into locale 1</em> from locale 0.   <em>Note:</em>
If two locales do not communicate, no line is drawn between them.
If communication is only one way, the communication color for
<em>no communication</em> is gray.</li>
<li><em>Data menu</em> controls what data is used for display
colors.   This initial data is for number of tasks for locales
and number of communications for the communication links.
For locales, one can select number of tasks, CPU time at the locale
or clock time at the locale.  Clock time is normally very close to
equal across all locales.  For the communication links, one can
select number of communications or size of data sent.</li>
</ul>
<h4>Display Interaction</h4>
<p>
Clicking on elements of the display will bring up more information.
Clicking on a locale will open a window for that locale showing
information for that locale.  For example, in example 1, clicking on
locale 0 will produce a window that looks like:
</p>
<img src="E1-L0.png" style="margin:10px; border: 2px solid black;">
<p>
(Note: There is overhead generated in tasks, CPU time and clock
time for the Visual Debug function calls.  <em>chplvis</em> removes
from the task count the overhead tasks but it can not remove the
CPU and clock time overhead.)
</p>
<p>
Clicking on the red part of the line between locale 0 and locale 1
will procduce a window that looks like:
</p>
<img src="E1-C1.0.png" style="margin:10px; border: 2px solid black;">
<p>
It is important to notice the direction of the "arrow" in the header
for the windows.   This is for communication from locale 1 to locale 0.
The total communication was 12.  It is further broken out into three
components:
<ul>
  <li> <em>Gets:</em> This is a communication initiated by locale 0 to
get a data located on locale 1.</li>
  <li> <em>Puts:</em> This is a communication initiated by <em>locale 1</em>
to put data from locale 1 onto locale 0.</li>
  <li> <em>Forks:</em> This where <em>locale 1</em> starts a task running
on locale 0.  As part of the task start, a block of data is sent to locale 0
as an argument to the task.</li>
</ul>

<h4>Example 2</h4>
In many programs, one will want to look at a number of small parts of
their program in addition to seeing the total statistics.  prog2.chpl
gives an example of using the <em>VisualDebug</em> functions
<em>tagVdebug(name)</em> and <em>pauseVdebug()</em>.
<pre style="margin:20px">
// Example 2 of use of VisualDebug module and chplvis tool.

use BlockDist;
use VisualDebug;

config var ncells = 10;

proc main() {

   // Create a couple of domains and a block mapped data array.
   const Domain = { 1 .. ncells };
   const mapDomain = Domain dmapped Block(Domain);

   var  data : [mapDomain] int = 1;

   // Start VisualDebug here
   startVdebug ("E2");

   // First computation step ... a simple forall
   forall i in Domain do data[i] += here.id + 1;

   // Write the result, we want to see the results of the above
   // so we tag before we continue.
   tagVdebug("writeln 1");
   writeln("data= ", data);

   // Second computation step ... using the distributed domain
   tagVdebug("step 2");
   forall i in mapDomain do data[i] += here.id+1;

   // Don't capture for the writeln
   pauseVdebug();
   writeln("data2= ", data);

   // Reduction step
   tagVdebug("reduce");
   var i = + reduce data;

   // done with visual debug
   stopVdebug();

   writeln ("sum is " + i + ".");
}
</pre>
<p>
Note that the <em>startVdebug("E2");</em> is places after the declarations
so that tasks and communication for the declarations are not included.
The initial display of <em>chplvis</em> shows data for the entire run.
</p>
<img src="E2-1.png" style="margin:10px; border: 2px solid black;">
<p>
There is now a new menu called <em>Tags</em> that refelcts the
<em>tagVdebug()</em> calls in the program.  Selecting the tags menu
gives the following display:
</p>
<img src="E2-2.png" style="margin:10px; border: 2px solid black;">
<p>
Notice that the tag names are in parentheses.  If a <em>tagVdebug()</em>
call is executed more than once, each execution will end up with a
different tag.  It is possible that this menu could be very long and
require scrolling to see all menu options.  There are two special
tags in this menu, <em>All</em> and <em>Start</em>.   <em>All</em> shows the
initial display for the entire run and <em>Start</em> shows the tasks and
communitation only between the <em>startVdebug("E2");</em> call and the
first call to <em>tagVdebug()</em>, in this case, <em>tagVdebug("writeln 1")</em>.
</p>
<p>
Selecting the tag menu option <em>Start</em> displays data for all
code between <em>startVdebug("E2")</em> and <em>tagVdebug("writeln 1")</em>.
<em>chplvis</em> shows the following:
</p>
<img src="E2-3.png" style="margin:10px; border: 2px solid black;">
<p>
You should be able to immediately see that
<ul>
  <li>Locale 0 has 3 tasks and all other locales do not have any tasks.
      (Task boxes colored white mean no tasks.)
      This means that locale 0 is doing all the computation.
  </li>
  <li>The majority of communication is happening from other locales to
      locale 0.  By clicking on the communication links you should be
      to easily see that locale 0 is doing gets and puts for all the
      communication.
  </li>
</ul>

</p>


</div>

</body>
</html>
