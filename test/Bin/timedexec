#!/usr/bin/perl

#
# @ARGV[0] = "-S"
# @ARGV[1] = <timeout value>
# @ARGV[2...] = command to run
#

$| = 1;					# will flush buffers after write

eval {
    local $SIG{ALRM} = sub { die "alarm\n" };
    alarm @ARGV[0];
    system @ARGV[1..$#ARGV];
    if ($? == -1) {
        print "timedexec failed to execute: $!\n";
        exit(1);
    } elsif ($? & 127) {
        printf "timedexec died with signal %d, %s coredump\n",
               ($? & 127), ($? & 128) ? 'with' : 'without';
        exit(1);
    } else {
        $cmdStatus = $? >> 8;
    }
    alarm 0;
};
die if $@ && $@ ne "alarm\n";
if ($@) {
    print "timedexec Alarm Clock\n";
    exit(222);
} else {
    exit($cmdStatus);
}
