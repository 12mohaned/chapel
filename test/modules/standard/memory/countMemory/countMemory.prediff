#!/usr/bin/env perl

$memfile = "/proc/meminfo";
$memfree = "unknown";

if (-r $memfile) {
  open MEMFILE, "$memfile" or die "can't open $memfile $!";
  my @memLines = <MEMFILE>;
  close (MEMFILE);

  foreach my $line (@memLines) {
    if ($line =~ m/MemTotal: (\s*)(\S*)/) {
      $memfree = "$2";
    }
  }
} else {
    $platform = `$ENV{CHPL_HOME}/util/chplenv/chpl_platform.py --target`; chomp($platform);
    printf "Platform is $platform\n";
    if ($platform eq "darwin") {
	$mem = `sysctl hw.memsize`;
	if ($mem =~ m/^hw.memsize: (\d*)$/) {
	    $memInBytes = "$1";
	    $memfree = $memInBytes / 1024;
	}
    }
}

if ($memfree ne "unknown") {
    $hostname = `hostname -s`; chomp($hostname);
    system("./countMemory.makegood $memfree > countMemory.$hostname.good");
}
