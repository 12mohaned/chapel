#!/usr/bin/env perl

$memfile = "/proc/meminfo";
$memFreeInBytes = "unknown";

if (-r $memfile) {
  open MEMFILE, "$memfile" or die "can't open $memfile $!";
  my @memLines = <MEMFILE>;
  close (MEMFILE);

  foreach my $line (@memLines) {
    if ($line =~ m/MemTotal: (\s*)(\S*)/) {
      $memFreeInBytes = "$2" * 1024;
    }
  }
} else {
    $platform = `$ENV{CHPL_HOME}/util/chplenv/chpl_platform.py --target`; chomp($platform);
    if ($platform eq "darwin") {
        $memFreeInBytes = `sysctl -n hw.memsize`; chomp($memFreeInBytes);
    }
}

if ($memFreeInBytes ne "unknown") {
    $hostname = `hostname -s`; chomp($hostname);
    system("./countMemory.makegood $memFreeInBytes > countMemory.$hostname.good");
}
