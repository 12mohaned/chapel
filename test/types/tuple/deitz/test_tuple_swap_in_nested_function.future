bug: flattening of nested functions incorrectly introduces copies
