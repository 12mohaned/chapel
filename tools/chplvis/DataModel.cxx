
#include "DataModel.h"

// C libraries

#include <stdio.h>
#include <string.h>
#include <stdlib.h>

int DataModel::LoadData(const char * filename)
{
  printf ("LoadData %s\n", filename);

  char *suffix = strrchr(filename, '-');
  if (!suffix) {
    fprintf (stderr,
	     "LoadData: file %s does not appear to be generated by Chapel\n",
	     filename);
    return 0;
  }
  suffix += 1;
  int namesize = strlen(filename) - strlen(suffix);
  int fileno = atoi(suffix);

  printf ("LoadData:  namesize is %d, fileno is %d\n", namesize, fileno);
  
  FILE *data = fopen(filename, "r");
  if (!data) {
    fprintf (stderr, "LoadData: Could not open %s.\n", filename);
    return 0;
  }

  // Read the config data
  char configline[100];

  if (fgets(configline, 100, data) != configline) {
    fprintf (stderr, "LoadData: Could not read file %s.\n", filename);
    fclose(data);
    return 0;
  }

  // The configuration data
  int nlocales;
  int fnum;

  if (sscanf(configline, "ChplVdebug: nodes %d, id %d",
	     &nlocales, &fnum) != 2) {
    fprintf (stderr, "LoadData: incorrect data on first line of %s.\n",
	     filename);
    fclose(data);
    return 0;
  }
  fclose(data);

  char fname[namesize+15];
  printf ("LoadData: nlocalse = %d, fnum = %d\n", nlocales, fnum);

  for (int i = 0; i < nlocales; i++) {
    snprintf (fname, namesize+15, "%.*s%d", namesize, filename, i);
    if (!LoadFile(fname)) {
      fprintf (stderr, "Error processing data from %s\n", fname);
      return 0;
    }
  }

  // Data is correctly loaded, set numLocales to show this.
  numLocales = nlocales;

  return 1;
}


// Load the data in the current file

int DataModel::LoadFile (const char *filename)
{
  FILE *data = fopen(filename, "r");
  char line[1024];

  if (!data) return 0;

  printf ("LoadFile %s\n", filename);

  while ( fgets(line, 1024, data) == line ) {
    // Process the line
  }

  if ( !feof(data) ) return 0;

  return 1;
}
